# 阿里云短信配置说明

## 配置示例

在 `config.yaml` 中配置阿里云短信服务：

```yaml
sms:
  provider: aliyun                    # 使用阿里云短信服务
  sign_name: "无人机平台"              # 短信签名（需在阿里云申请）
  template_code: "SMS_123456789"      # 短信模板CODE（需在阿里云申请）
  aliyun:
    access_key_id: "YOUR_ACCESS_KEY_ID"           # 阿里云AccessKey ID
    access_key_secret: "YOUR_ACCESS_KEY_SECRET"   # 阿里云AccessKey Secret
    region_id: "cn-hangzhou"                      # 区域ID
```

## 获取阿里云密钥

1. 登录 [阿里云控制台](https://ram.console.aliyun.com/manage/ak)
2. 创建 AccessKey ID 和 AccessKey Secret
3. 建议使用RAM子账号，并授予短信服务权限

## 配置短信签名和模板

1. 登录 [阿里云短信服务控制台](https://dysms.console.aliyun.com/)
2. 添加短信签名
   - 签名名称：无人机平台
   - 适用场景：验证码
   - 签名来源：企业全称或简称
3. 添加短信模板
   - 模板类型：验证码
   - 模板内容：`您的验证码为：${code}，${min}分钟内有效。`
   - 模板变量：code, min
   - 申请说明：用于用户登录验证
4. 等待审核通过（通常1个工作日内）
5. 审核通过后，获取模板CODE（如：SMS_123456789）

## 短信模板参数说明

本项目短信模板使用以下参数：
- `code`: 验证码（6位数字）
- `min`: 验证码有效时间（分钟）

代码中发送的模板参数格式：
```json
{
  "code": "123456",
  "min": "5"
}
```

## 使用方式

### 1. Mock 模式（开发测试）
```yaml
sms:
  provider: mock  # 不真实发送短信，仅在日志中输出
```

### 2. 阿里云模式（生产环境）
```yaml
sms:
  provider: aliyun
  sign_name: "无人机平台"
  template_code: "SMS_123456789"
  aliyun:
    access_key_id: "LTAIxxxxxxxxxxxx"
    access_key_secret: "xxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    region_id: "cn-hangzhou"
```

## API 调用示例

发送验证码接口：`POST /api/v1/auth/send-code`

请求体：
```json
{
  "phone": "13800138000"
}
```

成功响应：
```json
{
  "code": 200,
  "msg": "验证码发送成功"
}
```

## 错误处理

服务会自动处理以下错误情况：
- 客户端创建失败
- 网络请求失败
- 短信发送失败（余额不足、频率限制等）
- 参数验证失败

所有错误都会记录在日志中，并返回友好的错误提示。

## 费用说明

- 阿里云短信按条收费，具体价格参考 [阿里云短信价格](https://www.aliyun.com/price/product?spm=5176.8195934.J_5834642020.4.3e834183xCfqXd#/sms/detail)
- 建议在测试环境使用 `mock` 模式，避免产生不必要的费用
- 生产环境建议设置每日发送量限制

## 安全建议

1. **不要将密钥提交到版本控制系统**
   - 将 `config.yaml` 添加到 `.gitignore`
   - 使用环境变量或密钥管理服务

2. **使用RAM子账号**
   - 创建专门的RAM子账号用于短信服务
   - 仅授予必要的权限（AliyunDysmsFullAccess）

3. **设置发送频率限制**
   - 同一手机号1分钟内只能发送1次
   - 同一手机号1小时内最多发送5次
   - 同一手机号1天内最多发送10次

4. **监控异常流量**
   - 定期检查短信发送量
   - 设置异常告警阈值
